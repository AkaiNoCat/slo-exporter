stages:
  - check
  - build
  - build-ci-release-docker
  - pages

image: docker.dev.dszn.cz/golang-build:stretch

variables:
  DOCKER_NAMESPACE: sklik-devops

lint:
  stage: check
  script: |
    make lint

test:
  stage: check
  script: |
    make test-and-coverage
  artifacts:
    paths:
      - coverage.out
    expire_in: 1 week

build:
  stage: build
  script: |
    make build
  artifacts:
    paths:
      - slo_exporter
    expire_in: 1 week

build-ci-release-docker:
  image: docker.dev.dszn.cz/generic/ci-scripts:1
  stage: build-ci-release-docker
  script: |
    /ci/docker-build.sh --namespace $DOCKER_NAMESPACE
    /ci/docker-release-ci.sh --namespace $DOCKER_NAMESPACE --extra-tags "$CI_COMMIT_REF_NAME"
  dependencies:
    - build
  artifacts:
    expire_in: 1 mos
    paths:
      - docker-release-ci.uri

pages:
  stage: pages
  dependencies:
    - test
  only:
    - master
  script: |
    mkdir public
    go tool cover -html coverage.out -o public/index.html
  artifacts:
    expire_in: 1 mos
    paths:
      - public
